{% extends "base.html" %}

{% block content %}
<style>
    /* ê³„ì‚°ê¸° ìŠ¤íƒ€ì¼ ì¶”ê°€ */
    .calc-box {
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        padding: 15px;
        margin-top: 10px;
        border-radius: 8px;
        display: none; /* ê¸°ë³¸ì€ ìˆ¨ê¹€ */
        animation: fadeIn 0.3s ease-in-out;
    }
    .input-group {
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .input-group label {
        font-size: 0.9em;
        font-weight: bold;
        color: #555;
    }
    .input-group input, .input-group select {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: 140px;
        text-align: right;
    }
    .result {
        margin-top: 15px;
        padding-top: 10px;
        border-top: 2px dashed #bbb;
    }
    .result p {
        margin: 5px 0;
        display: flex;
        justify-content: space-between;
    }
    .total-price {
        color: #d32f2f;
        font-weight: bold;
        font-size: 1.1em;
        border-top: 1px solid #eee;
        padding-top: 10px;
        margin-top: 10px !important;
    }
    .btn-calc {
        width: 100%;
        background-color: #007bff;
        color: white;
        padding: 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
        font-weight: bold;
    }
    .btn-calc:hover { background-color: #0056b3; }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<div class="phone-container">
    <h2 style="text-align: center; margin-bottom: 30px;">ğŸ“± ëª¨ë¸ë³„ ì„±ì§€ ê³„ì‚°ê¸°</h2>
    
    <div class="grid">
        {% for phone in phones %}
        <div class="card">
            <h3>{{ phone.name }}</h3>
            <p>ë¸Œëœë“œ: {{ phone.brand }}</p>
            <p>ìš©ëŸ‰: {{ phone.storage }}</p>
            <p class="price">ì¶œê³ ê°€: <span id="factory-price-{{ phone.id }}">{{ "{:,}".format(phone.price) }}</span>ì›</p>
            
            <button class="btn-calc" onclick="toggleCalc('{{ phone.id }}')">ğŸ‘‡ ê²¬ì  ê³„ì‚°ê¸° ì—´ê¸°</button>

            <div id="calc-area-{{ phone.id }}" class="calc-box">
                <div class="input-group">
                    <label>ê³µì‹œì§€ì›ê¸ˆ(-)</label>
                    <input type="number" id="public-subsidy-{{ phone.id }}" placeholder="0" oninput="calculate('{{ phone.id }}', {{ phone.price }})">
                </div>
                <div class="input-group">
                    <label style="color:#d32f2f;">ëŒ€ë¦¬ì  ì§€ì›ê¸ˆ(-)</label>
                    <input type="number" id="store-subsidy-{{ phone.id }}" placeholder="ì˜ˆ: 300000" oninput="calculate('{{ phone.id }}', {{ phone.price }})">
                </div>

                <div class="input-group">
                    <label>ì›” ìš”ê¸ˆì œ</label>
                    <input type="number" id="plan-fee-{{ phone.id }}" value="89000" oninput="calculate('{{ phone.id }}', {{ phone.price }})">
                </div>
                <div class="input-group">
                    <label>ìš”ê¸ˆí• ì¸(ì„ íƒì•½ì •)</label>
                    <select id="contract-type-{{ phone.id }}" onchange="calculate('{{ phone.id }}', {{ phone.price }})">
                        <option value="0">ë¯¸ì ìš© (ê³µì‹œì§€ì› ì‹œ)</option>
                        <option value="0.25">25% í• ì¸ ì ìš©</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>ë¶€ê°€ì„œë¹„ìŠ¤(ì›”)</label>
                    <input type="number" id="addon-fee-{{ phone.id }}" placeholder="ì˜ˆ: 9900" oninput="calculate('{{ phone.id }}', {{ phone.price }})">
                </div>
                <div class="input-group">
                    <label>ìœ ì§€ ê¸°ê°„(ê°œì›”)</label>
                    <input type="number" id="addon-months-{{ phone.id }}" placeholder="ì˜ˆ: 3" value="3" oninput="calculate('{{ phone.id }}', {{ phone.price }})">
                </div>

                <div class="result">
                    <p>í• ë¶€ì›ê¸ˆ: <span id="principal-{{ phone.id }}">0</span>ì›</p>
                    <p>ì›” ê¸°ê¸°ê°’(5.9%ì´ì): <span id="monthly-device-{{ phone.id }}">0</span>ì›</p>
                    <p>ì›” í†µì‹ ë£Œ: <span id="monthly-plan-{{ phone.id }}">0</span>ì›</p>
                    <hr>
                    <p class="total-price">
                        ì›” ë‚©ë¶€ì•¡(ì´ˆê¸°): <span id="total-monthly-{{ phone.id }}">0</span>ì›
                    </p>
                    <p style="font-size:0.8em; color:#666; text-align:right;">
                        (ë¶€ê°€ì„œë¹„ìŠ¤ ì¢…ë£Œ í›„: <span id="total-after-addon-{{ phone.id }}">0</span>ì›)
                    </p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    function toggleCalc(id) {
        var x = document.getElementById("calc-area-" + id);
        if (x.style.display === "block") {
            x.style.display = "none";
        } else {
            x.style.display = "block";
        }
    }

    function calculate(id, factoryPrice) {
        var publicSubsidy = Number(document.getElementById('public-subsidy-' + id).value) || 0;
        var storeSubsidy = Number(document.getElementById('store-subsidy-' + id).value) || 0;
        var planFee = Number(document.getElementById('plan-fee-' + id).value) || 0;
        var discountRate = Number(document.getElementById('contract-type-' + id).value);
        var addonFee = Number(document.getElementById('addon-fee-' + id).value) || 0;
        
        var principal = factoryPrice - publicSubsidy - storeSubsidy;
        if (principal < 0) principal = 0;

        var installMonths = 24;
        var annualInterest = 0.059;
        var monthlyDeviceCost = 0;

        if (principal > 0) {
            var r = annualInterest / 12;
            monthlyDeviceCost = principal * (r * Math.pow((1 + r), installMonths)) / (Math.pow((1 + r), installMonths) - 1);
        }
        monthlyDeviceCost = Math.floor(monthlyDeviceCost);

        var monthlyPlanCost = planFee * (1 - discountRate);

        var totalInitial = monthlyDeviceCost + monthlyPlanCost + addonFee;
        var totalAfter = monthlyDeviceCost + monthlyPlanCost;

        document.getElementById('principal-' + id).innerText = principal.toLocaleString();
        document.getElementById('monthly-device-' + id).innerText = monthlyDeviceCost.toLocaleString();
        document.getElementById('monthly-plan-' + id).innerText = monthlyPlanCost.toLocaleString();
        document.getElementById('total-monthly-' + id).innerText = totalInitial.toLocaleString();
        document.getElementById('total-after-addon-' + id).innerText = totalAfter.toLocaleString();
    }
</script>
{% endblock %}