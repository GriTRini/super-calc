{% extends "base.html" %}

{% block content %}
<style>
    /* 1. ì „ì²´ ë ˆì´ì•„ì›ƒ */
    .calc-container { max-width: 100%; box-sizing: border-box; }
    
    .section-box {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        margin-bottom: 20px;
        word-break: keep-all; 
    }

    .form-label {
        font-weight: bold;
        color: #555;
        display: block;
        margin-bottom: 8px;
        font-size: 0.95rem;
    }

    /* 2. ì…ë ¥ì°½ ë””ìì¸ */
    /* text íƒ€ì…ì´ì§€ë§Œ ìˆ«ì í‚¤íŒ¨ë“œê°€ ëœ¨ë„ë¡ inputmode ì„¤ì •ë¨ */
    input[type="text"], input[type="number"], select {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        box-sizing: border-box;
        text-align: right; /* ìˆ«ìëŠ” ì˜¤ë¥¸ìª½ ì •ë ¬ì´ êµ­ë£° */
        font-family: 'Pretendard', sans-serif; /* ìˆ«ì í°íŠ¸ ê¹”ë”í•˜ê²Œ */
    }

    input:focus, select:focus { border-color: #007bff; outline: none; }

    /* ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ */
    input:disabled {
        background-color: #e9ecef !important;
        color: #adb5bd !important;
        cursor: not-allowed;
    }

    /* í•œê¸€ ê¸ˆì•¡ í‘œì‹œ (ìš°ì¸¡ í•˜ë‹¨) */
    .unit-text {
        text-align: right;
        font-size: 0.85rem;
        color: #007bff;
        margin-top: 4px;
        font-weight: bold;
        min-height: 1.2em; /* ê³µê°„ í™•ë³´ */
    }

    /* 3. ê·¸ë¦¬ë“œ */
    .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 768px) { .input-grid { grid-template-columns: 1fr; } }

    /* 4. ê²°ê³¼ ë°•ìŠ¤ */
    .result-box {
        margin-top: 30px;
        border-radius: 15px;
        overflow: hidden;
        background: white;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        border: 2px solid #eee;
    }
    .result-header { padding: 20px; text-align: center; color: white; }
    .result-body { display: flex; position: relative; }
    .result-col { flex: 1; padding: 25px 20px; display: flex; flex-direction: column; align-items: center; }
    .result-divider { width: 1px; background-color: #eee; margin: 20px 0; }
    .winner-bg { background-color: #f0f7ff; }
</style>

<div class="calc-container">
    <div style="text-align: center; margin-bottom: 30px;">
        <h2 style="font-size: 1.8rem; color: #333; margin-bottom: 10px;">ğŸ“‰ ìê¸‰ì œ vs ì„±ì§€ ê°€ê²© ë¹„êµ</h2>
        <p style="color: #666;">ì´ˆê¸° 6ê°œì›” ìš”ê¸ˆì œ ìœ ì§€ ì¡°ê±´ê¹Œì§€ <span style="color: #d32f2f; font-weight: bold;">ì™„ë²½ ë°˜ì˜!</span></p>
    </div>

    <div class="section-box">
        <form action="/calc" method="post" id="calcForm" onsubmit="return prepareSubmit()">
            
            <div style="margin-bottom: 30px; background-color: #f8f9fa; padding: 20px; border-radius: 10px; border: 1px solid #e9ecef;">
                <div style="margin-bottom: 15px;">
                    <span class="form-label">ğŸ“± ë¹„êµí•  ê¸°ê¸° ì„ íƒ</span>
                    <select name="phone_code" id="phone_select" onchange="updatePrice()" style="text-align: left;">
                        {% for code, info in phones.items() %}
                        <option value="{{ code }}" data-price="{{ info.price }}" {% if selected_code == code %}selected{% endif %}>
                            {{ info.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <span class="form-label">ğŸ’° ê¸°ê¸°ê°’ (ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥)</span>
                    <input type="text" inputmode="numeric" name="device_price" id="device_price" 
                           value="{{ input_price|default(0) }}" 
                           onkeyup="formatNumber(this)" 
                           style="border: 2px solid #007bff; font-weight: bold;">
                    <div id="unit_device_price" class="unit-text"></div>
                </div>
            </div>

            <div class="input-grid">
                <div style="background-color: #fff; padding: 20px; border-radius: 10px; border: 1px solid #ddd;">
                    <h3 style="text-align: center; color: #333; margin-bottom: 20px; font-size: 1.2rem;">ğŸª™ ìê¸‰ì œ + ì•Œëœ°í°</h3>
                    <div style="margin-bottom: 15px;">
                        <span class="form-label">ì•Œëœ°í° ìš”ê¸ˆì œ (ì›”)</span>
                        <input type="text" inputmode="numeric" name="mvno_cost" id="mvno_cost"
                               placeholder="33,000" value="{{ input_mvno|default(33000) }}" 
                               onkeyup="formatNumber(this)">
                        <div id="unit_mvno_cost" class="unit-text"></div>
                    </div>
                </div>

                <div style="background-color: #e3f2fd; padding: 20px; border-radius: 10px; border: 1px solid #90caf9;">
                    <h3 style="text-align: center; color: #0d47a1; margin-bottom: 20px; font-size: 1.2rem;">ğŸ¢ í†µì‹ ì‚¬ ì•½ì •</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <span class="form-label">í• ì¸ ë°©ì‹ ì„ íƒ</span>
                        <div style="display: flex; gap: 10px; background: white; padding: 10px; border-radius: 8px;">
                            <label style="cursor: pointer; flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px;">
                                <input type="radio" name="carrier_type" value="gongsi" onclick="checkSubsidyStatus()" 
                                {% if carrier_type == 'gongsi' or carrier_type is not defined %}checked{% endif %}> 
                                <span>ê³µì‹œì§€ì›ê¸ˆ</span>
                            </label>
                            <label style="cursor: pointer; flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px;">
                                <input type="radio" name="carrier_type" value="seonyak" onclick="checkSubsidyStatus()" 
                                {% if carrier_type == 'seonyak' %}checked{% endif %}> 
                                <span>ì„ íƒì•½ì •</span>
                            </label>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px; border: 1px dashed #0d47a1; padding: 15px; border-radius: 8px; background: #f0f7ff;">
                        <div style="margin-bottom: 10px;">
                            <span class="form-label" style="font-size:0.9em;">â‘  ì´ˆê¸° ìš”ê¸ˆì œ & ìœ ì§€ê¸°ê°„</span>
                            <div style="display: flex; gap: 5px;">
                                <div style="flex: 2;">
                                    <input type="text" inputmode="numeric" name="plan_cost" id="plan_cost"
                                           placeholder="ì˜ˆ: 100,000" value="{{ input_plan|default(90000) }}"
                                           onkeyup="formatNumber(this)">
                                    <div id="unit_plan_cost" class="unit-text"></div>
                                </div>
                                <div style="flex: 1; position: relative;">
                                    <input type="number" name="plan_period" value="{{ input_plan_period|default(6) }}" style="text-align: center;">
                                    <span style="position: absolute; right: 5px; top: 12px; font-size: 0.8em; color: #888; pointer-events: none;">ê°œì›”</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <span class="form-label" style="font-size:0.9em;">â‘¡ ì´í›„ ë³€ê²½ ìš”ê¸ˆì œ</span>
                            <input type="text" inputmode="numeric" name="plan_cost_after" id="plan_cost_after"
                                   placeholder="ì˜ˆ: 69,000" value="{{ input_plan_after|default('') }}"
                                   onkeyup="formatNumber(this)">
                            <div id="unit_plan_cost_after" class="unit-text"></div>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <span class="form-label">ê³µì‹œì§€ì›ê¸ˆ (ê¸°ê¸°ê°’ í• ì¸)</span>
                        <input type="text" inputmode="numeric" id="subsidy_input" name="subsidy" 
                               placeholder="500,000" value="{{ input_subsidy|default(500000) }}"
                               onkeyup="formatNumber(this)">
                        <div id="unit_subsidy_input" class="unit-text"></div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <span class="form-label" style="color: #d32f2f;">ğŸ’¸ ëŒ€ë¦¬ì  ì§€ì›ê¸ˆ (ì§•)</span>
                        <input type="text" inputmode="numeric" name="store_subsidy" id="store_subsidy"
                               placeholder="ì˜ˆ: 300,000" value="{{ input_store_subsidy|default(0) }}" 
                               style="border: 2px solid #ffcdd2; background-color: #fff5f5;"
                               onkeyup="formatNumber(this)">
                        <div id="unit_store_subsidy" class="unit-text"></div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <span class="form-label" style="color: #007bff;">â• ë¶€ê°€ì„œë¹„ìŠ¤ (ê¸ˆì•¡ / ê°œì›”)</span>
                        <div style="display: flex; gap: 5px;">
                            <div style="flex: 2;">
                                <input type="text" inputmode="numeric" name="addon_cost" id="addon_cost"
                                       placeholder="ê¸ˆì•¡" value="{{ input_addon_cost|default('') }}" 
                                       style="border: 1px solid #90caf9;"
                                       onkeyup="formatNumber(this)">
                                <div id="unit_addon_cost" class="unit-text"></div>
                            </div>
                            <div style="flex: 1;">
                                <input type="number" name="addon_months" placeholder="3" value="{{ input_addon_months|default(3) }}" 
                                       style="border: 1px solid #90caf9; text-align: center;">
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <span class="form-label">ì¶”ê°€ ì›” í• ì¸ (ê²°í•© ë“±)</span>
                        <input type="text" inputmode="numeric" name="add_discount" id="add_discount"
                               placeholder="0" value="{{ input_add_discount|default(0) }}"
                               onkeyup="formatNumber(this)">
                        <div id="unit_add_discount" class="unit-text"></div>
                    </div>
                </div>
            </div>
            
            <button type="submit" class="btn-yellow">ğŸ’° ìµœì €ê°€ ë¹„êµí•˜ê¸°</button>
        </form>
    </div>

    {% if result %}
    <div class="result-box" style="border-color: {% if winner == 'self' %}#333{% else %}#0d47a1{% endif %};">
        <div class="result-header" style="background-color: {% if winner == 'self' %}#333{% else %}#0d47a1{% endif %};">
            <h2 style="margin: 0; font-size: 1.6rem;">ğŸ† {{ recommend_text }}</h2>
            <p style="margin-top: 5px; opacity: 0.9;">2ë…„ê°„ ì´ <span style="font-weight: bold; color: #ffeb3b;">{{ "{:,}".format(diff_price) }}ì›</span> ì ˆì•½!</p>
        </div>
        
        <div class="result-body">
            <div class="result-col {% if winner == 'self' %}winner-bg{% endif %}">
                <h3 style="color: #333; margin-bottom: 10px;">ìê¸‰ì œ</h3>
                <div style="text-align: center;">
                    <p style="font-size: 0.9rem; color: #666;">2ë…„ ì´ ë¹„ìš©</p>
                    <p style="font-size: 1.6rem; font-weight: bold; color: #333; margin: 5px 0;">{{ "{:,}".format(self_total) }}ì›</p>
                </div>
                <div style="margin-top: 15px; width: 100%; font-size: 0.85rem; color: #555; background: rgba(0,0,0,0.03); padding: 10px; border-radius: 8px;">
                    <p>â€¢ ê¸°ê¸°ê°’: {{ "{:,}".format(input_price) }}ì›</p>
                    <p>â€¢ ì•Œëœ°í°: {{ "{:,}".format(input_mvno * 24) }}ì›</p>
                </div>
            </div>

            <div class="result-divider"></div>

            <div class="result-col {% if winner == 'carrier' %}winner-bg{% endif %}">
                <h3 style="color: #0d47a1; margin-bottom: 10px;">í†µì‹ ì‚¬</h3>
                <div style="text-align: center;">
                    <p style="font-size: 0.9rem; color: #666;">2ë…„ ì´ ë¹„ìš©</p>
                    <p style="font-size: 1.6rem; font-weight: bold; color: #0d47a1; margin: 5px 0;">{{ "{:,}".format(carrier_total) }}ì›</p>
                </div>
                <div style="margin-top: 15px; width: 100%; font-size: 0.85rem; color: #555; background: rgba(13, 71, 161, 0.05); padding: 10px; border-radius: 8px;">
                    <p style="display: flex; justify-content: space-between;"><span>í• ë¶€ì›ê¸ˆ</span><b>{{ "{:,}".format(carrier_principal) }}ì›</b></p>
                    <p style="display: flex; justify-content: space-between;"><span>ì´ì(5.9%)</span><span>+{{ "{:,}".format(carrier_interest) }}ì›</span></p>
                    <p style="display: flex; justify-content: space-between;"><span>í†µì‹ ë£Œ</span><span>+{{ "{:,}".format(plan_total_cost) }}ì›</span></p>
                    {% if input_addon_cost > 0 %}
                    <p style="display: flex; justify-content: space-between; color: #d32f2f;"><span>ë¶€ê°€ì„œë¹„ìŠ¤</span><span>+{{ "{:,}".format(addon_total_cost) }}ì›</span></p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
    // 1. ìˆ«ì í¬ë§·íŒ… (ì½¤ë§ˆ + í•œê¸€ ë³€í™˜)
    function formatNumber(input) {
        // ìˆ«ìë§Œ ë‚¨ê¸°ê¸°
        let rawValue = input.value.replace(/[^0-9]/g, '');
        
        // 0 ì œê±° (ë§¨ ì•ì˜ 0)
        if(rawValue.length > 1 && rawValue.startsWith('0')) {
            rawValue = rawValue.substring(1);
        }

        if (!rawValue) {
            input.value = '';
            document.getElementById('unit_' + input.id).innerText = '';
            return;
        }

        // ì½¤ë§ˆ ì¶”ê°€í•´ì„œ ì…ë ¥ì°½ì— ë°˜ì˜
        input.value = Number(rawValue).toLocaleString();

        // í•œê¸€ ë‹¨ìœ„ ë³€í™˜ (ì˜ˆ: 500000 -> 50ë§Œì›)
        let unitText = convertToKoreanNumber(rawValue);
        
        // í•´ë‹¹ inputì˜ idë¥¼ ì´ìš©í•´ unit í…ìŠ¤íŠ¸ div ì°¾ê¸°
        let unitDiv = document.getElementById('unit_' + input.id);
        if (unitDiv) {
            unitDiv.innerText = unitText;
        }
    }

    // í•œê¸€ ê¸ˆì•¡ ë³€í™˜ í—¬í¼ í•¨ìˆ˜
    function convertToKoreanNumber(num) {
        let number = parseInt(num, 10);
        if (isNaN(number) || number === 0) return '';
        
        let result = '';
        let tenThousand = Math.floor(number / 10000); // ë§Œ ë‹¨ìœ„
        let rest = number % 10000; // ë‚˜ë¨¸ì§€

        if (tenThousand > 0) {
            // ì–µ ë‹¨ìœ„ ì²´í¬
            let hundredMillion = Math.floor(tenThousand / 10000);
            let restTenThousand = tenThousand % 10000;

            if (hundredMillion > 0) {
                result += hundredMillion + 'ì–µ ';
            }
            if (restTenThousand > 0) {
                result += restTenThousand + 'ë§Œ ';
            } else if (hundredMillion === 0) {
                 result += tenThousand + 'ë§Œ ';
            } else {
                 // 1ì–µ 0ë§Œ -> 1ì–µ
            }
        }
        
        if (rest > 0) {
            result += rest;
        }
        
        return result + 'ì›';
    }

    // 2. í¼ ì œì¶œ ì‹œ ì½¤ë§ˆ ì œê±° (ì„œë²„ëŠ” intë§Œ ë°›ìœ¼ë¯€ë¡œ)
    function prepareSubmit() {
        // text íƒ€ì…ì´ê³  onkeyupì´ ìˆëŠ” ëª¨ë“  ì¸í’‹ ì°¾ê¸°
        const inputs = document.querySelectorAll('input[type="text"][onkeyup]');
        inputs.forEach(input => {
            // ì½¤ë§ˆ ì œê±°
            input.value = input.value.replace(/,/g, '');
        });
        return true; // í¼ ì œì¶œ ì§„í–‰
    }

    // 3. ê¸°ê¸° ë³€ê²½ ì‹œ ê°€ê²© ì—…ë°ì´íŠ¸
    function updatePrice() {
        const select = document.getElementById("phone_select");
        const priceInput = document.getElementById("device_price");
        
        if (select && priceInput) {
            const selectedOption = select.options[select.selectedIndex];
            const price = selectedOption.dataset.price; 
            
            if (price) {
                priceInput.value = price; // ì¼ë‹¨ ê°’ ë„£ê³ 
                formatNumber(priceInput); // ì½¤ë§ˆ+í•œê¸€ ì ìš©
            }
        }
    }

    // 4. ì„ íƒì•½ì •/ê³µì‹œì§€ì›ê¸ˆ í† ê¸€
    function checkSubsidyStatus() {
        const checkedRadio = document.querySelector('input[name="carrier_type"]:checked');
        const subsidyInput = document.getElementById("subsidy_input");
        const subsidyUnit = document.getElementById("unit_subsidy_input");
        
        if (checkedRadio && subsidyInput) {
            if (checkedRadio.value === 'seonyak') {
                subsidyInput.disabled = true;
                subsidyInput.value = ''; // 0ìœ¼ë¡œ ë³´ì´ê²Œ í•˜ê±°ë‚˜ ë¹„ì›€
                subsidyInput.style.backgroundColor = '#e9ecef';
                subsidyInput.placeholder = "ì§€ì›ê¸ˆ ì—†ìŒ";
                if(subsidyUnit) subsidyUnit.innerText = '';
            } else {
                subsidyInput.disabled = false;
                subsidyInput.style.backgroundColor = 'white';
                subsidyInput.placeholder = "500,000";
            }
        }
    }

    // 5. ì´ˆê¸°í™”
    window.addEventListener('DOMContentLoaded', function() {
        // ëª¨ë“  í¬ë§·íŒ… ëŒ€ìƒ ì¸í’‹ ì´ˆê¸°í™” (ì´ë¯¸ ê°’ì´ ìˆëŠ” ê²½ìš° í¬ë§·íŒ… ì ìš©)
        const inputs = document.querySelectorAll('input[type="text"][onkeyup]');
        inputs.forEach(input => {
            formatNumber(input);
        });

        // ê²°ê³¼í™”ë©´ ì•„ë‹ë•Œë§Œ ê°€ê²© ìë™ ì„ íƒ
        {% if not result %}
            updatePrice();
        {% endif %}
        
        checkSubsidyStatus();
    });
</script>

{% endblock %}